<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias de VTC en RD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .company-btn.active {
            background-color: #1D4ED8; /* bg-blue-700 */
            color: white;
            box-shadow: 0 4px 14px 0 rgb(0 0 0 / 10%);
        }
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-white text-gray-800 antialiased">
    <div class="container mx-auto px-4 py-8 md:py-12">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Noticias del Sector VTC</h1>
            <p class="text-lg text-gray-600 mt-2">República Dominicana</p>
        </header>

        <main>
            <div class="flex justify-center items-center space-x-4 mb-6">
                <div>
                    <label for="select-month" class="block text-sm font-medium text-gray-700 text-center">Mes</label>
                    <select id="select-month" name="month" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="select-year" class="block text-sm font-medium text-gray-700 text-center">Año</label>
                    <select id="select-year" name="year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>

            <div class="flex justify-center items-center space-x-2 md:space-x-4 mb-8">
                <button id="btn-uber" class="company-btn text-base md:text-lg font-semibold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out bg-gray-100 hover:bg-gray-200" onclick="getNews('Uber')">
                    Uber
                </button>
                <button id="btn-didi" class="company-btn text-base md:text-lg font-semibold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out bg-gray-100 hover:bg-gray-200" onclick="getNews('DiDi')">
                    DiDi
                </button>
                <button id="btn-indrive" class="company-btn text-base md:text-lg font-semibold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out bg-gray-100 hover:bg-gray-200" onclick="getNews('inDrive')">
                    inDrive
                </button>
            </div>
            
            <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4 hidden max-w-md mx-auto">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>

            <div id="news-container" class="mt-6">
                 <div id="placeholder" class="text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Selecciona una compañía</h3>
                    <p class="mt-1 text-sm text-gray-500">Elige una de las opciones de arriba para ver las últimas noticias.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const newsContainer = document.getElementById('news-container');
        const placeholder = document.getElementById('placeholder');
        const buttons = document.querySelectorAll('.company-btn');
        const monthSelect = document.getElementById('select-month');
        const yearSelect = document.getElementById('select-year');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        
        let activeCompany = null;
        let progressInterval;

        function populateMonths() {
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
        }

        function populateYears() {
            const currentYear = 2025;
            for (let i = currentYear; i >= currentYear - 5; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
        }
        
        // Inicializar selectores de fecha
        document.addEventListener('DOMContentLoaded', () => {
            populateMonths();
            populateYears();
            // Establecer valores predeterminados para Octubre de 2025
            monthSelect.value = 10;
            yearSelect.value = 2025;
        });

        function extractJson(text) {
            const match = text.match(/```json\s*([\s\S]*?)\s*```/);
            return match ? match[1] : null;
        }
        
        function startProgress() {
            clearInterval(progressInterval);
            progressBar.style.width = '0%';
            progressBarContainer.classList.remove('hidden');
            let width = 0;
            progressInterval = setInterval(() => {
                if (width < 90) {
                    width += 5;
                    progressBar.style.width = width + '%';
                } else {
                    clearInterval(progressInterval);
                }
            }, 100);
        }
        
        function completeProgress() {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressBarContainer.classList.add('hidden');
            }, 500);
        }

        async function getNews(company) {
            if (activeCompany === company) return;
            
            activeCompany = company;
            updateActiveButton(company);

            newsContainer.innerHTML = '';
            placeholder.classList.add('hidden');
            startProgress();

            const apiKey = ""; // API key will be injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const selectedYear = yearSelect.value;
            const monthName = monthSelect.options[monthSelect.selectedIndex].text;

            const systemPrompt = "Eres un asistente agregador de noticias. Tu tarea es encontrar los 3 artículos de noticias más recientes y relevantes sobre una compañía de VTC (Vehículo de Transporte con Conductor) específica en la República Dominicana para un mes y año determinados. Debes responder únicamente con un bloque de código JSON markdown que contenga un objeto con una clave 'articles'. La clave 'articles' debe ser una lista de objetos. Cada objeto de artículo debe tener las propiedades 'resumen', 'fuente' y 'fecha'. No incluyas ningún texto explicativo fuera del bloque de código JSON. Tu respuesta debe empezar con ```json y terminar con ```.";
            const userQuery = `Encuentra 3 noticias reales y recientes sobre ${company} en la República Dominicana durante ${monthName} de ${selectedYear}.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorDetail = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.error?.message || JSON.stringify(errorData);
                    } catch (e) {
                        // Ignorar si el cuerpo de la respuesta no es JSON
                    }
                    throw new Error(`Error en la API: ${errorDetail}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const rawText = candidate.content.parts[0].text;
                    const jsonString = extractJson(rawText);
                    if (jsonString) {
                         const parsedJson = JSON.parse(jsonString);
                         displayNews(parsedJson.articles, company);
                    } else {
                        throw new Error('La respuesta del servidor no contenía un JSON válido.');
                    }
                } else {
                    throw new Error('No se encontraron noticias o la respuesta del servidor no fue válida.');
                }
            } catch (error) {
                console.error('Error fetching news:', error);
                displayError(error.message || 'No se pudieron cargar las noticias. Por favor, intenta de nuevo más tarde.');
                activeCompany = null; 
                updateActiveButton(null);
            } finally {
                completeProgress();
            }
        }

        function displayNews(articles, company) {
            if (!articles || articles.length === 0) {
                newsContainer.innerHTML = `<p class="text-center text-gray-500">No se encontraron noticias recientes para ${company} en el período seleccionado.</p>`;
                activeCompany = null;
                updateActiveButton(null);
                return;
            }

            const articlesHtml = articles.map(article => `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-4 transform hover:scale-[1.02] transition-transform duration-300 ease-out shadow-sm">
                    <p class="text-gray-800 mb-4">${article.resumen}</p>
                    <div class="flex items-center text-sm text-gray-500">
                        <span class="font-semibold mr-2">${article.fuente}</span>
                        <span>-</span>
                        <span class="ml-2">${article.fecha}</span>
                    </div>
                </div>
            `).join('');
            
            newsContainer.innerHTML = `<div class="space-y-6">${articlesHtml}</div>`;
        }

        function displayError(message) {
            newsContainer.innerHTML = `<p class="text-center text-red-500 p-4 bg-red-50 rounded-lg">${message}</p>`;
        }

        function updateActiveButton(company) {
            buttons.forEach(button => {
                if (button.id === `btn-${company?.toLowerCase()}`) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>

